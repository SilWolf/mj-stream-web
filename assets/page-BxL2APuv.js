import{r as j,j as e,M as S}from"./index-D_zi-PEm.js";import{u as C}from"./index-DAMtnkVo.js";import{R as x,p as i,u as M}from"./mahjong.helper-DVgaoY_t.js";import{M as k}from"./index-CN5arYme.js";import{M as a}from"./index-G2P5mRlY.js";import{u as b}from"./useToggle-CsODXG4L.js";const o=({player:s})=>e.jsxs("div",{className:"border-b-4 pb-1",style:{borderColor:s.color},children:[e.jsx("p",{className:"text-sm text-neutral-600",children:s.secondaryName}),e.jsx("p",{className:"font-bold",children:s.primaryName})]});function d({value:s}){return e.jsx(a,{value:s,positiveClassName:"text-green-600",negativeClassName:"text-red-600",signed:!0,hideZero:!0})}const p=({matchRound:s,playerIndex:l})=>e.jsxs("span",{children:[s.playerResults[l].isRiichi&&e.jsx("span",{className:"text-xs",children:"立"}),s.resultType===x.Ron&&s.playerResults[l].type===i.Lose&&e.jsx("span",{className:"text-xs",children:"統"}),s.resultType===x.Ron&&s.playerResults[l].type===i.Win&&e.jsx("span",{className:"text-xs",children:"和"}),s.resultType===x.SelfDrawn&&s.playerResults[l].type===i.Win&&e.jsx("span",{className:"text-xs",children:"摸"}),s.resultType===x.Exhausted&&s.playerResults[l].type===i.Win&&e.jsx("span",{className:"text-xs",children:"聽"})]});function w({players:s,matchRounds:l,...c}){const r=j.useMemo(()=>Object.entries(l??{}),[l]);return e.jsxs("table",{...c,children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-400 [&>th]:p-2",children:[e.jsx("th",{className:"whitespace-nowrap px-16",children:"局數"}),e.jsx("th",{className:"w-1/4",children:e.jsx(o,{player:s[0]})}),e.jsx("th",{className:"w-1/4",children:e.jsx(o,{player:s[1]})}),e.jsx("th",{className:"w-1/4",children:e.jsx(o,{player:s[2]})}),e.jsx("th",{className:"w-1/4",children:e.jsx(o,{player:s[3]})})]})}),e.jsxs("tbody",{children:[r[0]&&e.jsxs("tr",{className:"even:bg-gray-200 [&>td]:p-2",children:[e.jsx("td",{className:"text-center"}),e.jsx("td",{className:"text-center",children:e.jsx(a,{value:r[0][1].playerResults[0].beforeScore})}),e.jsx("td",{className:"text-center",children:e.jsx(a,{value:r[0][1].playerResults[1].beforeScore})}),e.jsx("td",{className:"text-center",children:e.jsx(a,{value:r[0][1].playerResults[2].beforeScore})}),e.jsx("td",{className:"text-center",children:e.jsx(a,{value:r[0][1].playerResults[3].beforeScore})})]}),r.map(([n,t])=>t.resultType===x.Hotfix?e.jsxs("tr",{className:"even:bg-gray-200 [&>td]:p-2",children:[e.jsx("td",{className:"text-center whitespace-nowrap px-16",children:"手動調整"}),e.jsx("td",{className:"text-center",children:t.playerResults[0].afterScore}),e.jsx("td",{className:"text-center",children:t.playerResults[1].afterScore}),e.jsx("td",{className:"text-center",children:t.playerResults[2].afterScore}),e.jsx("td",{className:"text-center",children:t.playerResults[3].afterScore})]},n):e.jsxs("tr",{className:"even:bg-gray-200 [&>td]:p-2",children:[e.jsx("td",{className:"text-center whitespace-nowrap",children:e.jsx(k,{roundCount:t.roundCount,extendedRoundCount:t.extendedRoundCount,max:8,className:"px-4"})}),e.jsxs("td",{className:"text-center",children:[e.jsx(d,{value:t.playerResults[0].afterScore-t.playerResults[0].beforeScore})," ",e.jsx(p,{matchRound:t,playerIndex:"0"})]}),e.jsxs("td",{className:"text-center",children:[e.jsx(d,{value:t.playerResults[1].afterScore-t.playerResults[1].beforeScore})," ",e.jsx(p,{matchRound:t,playerIndex:"1"})]}),e.jsxs("td",{className:"text-center",children:[e.jsx(d,{value:t.playerResults[2].afterScore-t.playerResults[2].beforeScore})," ",e.jsx(p,{matchRound:t,playerIndex:"2"})]}),e.jsxs("td",{className:"text-center",children:[e.jsx(d,{value:t.playerResults[3].afterScore-t.playerResults[3].beforeScore})," ",e.jsx(p,{matchRound:t,playerIndex:"3"})]})]},n)),r[r.length-1]&&e.jsxs("tr",{className:"even:bg-gray-200 [&>td]:p-2",children:[e.jsx("td",{className:"text-center whitespace-nowrap px-16"}),e.jsx("td",{className:"text-center font-bold text-lg",children:e.jsx(a,{value:r[r.length-1][1].playerResults[0].afterScore})}),e.jsx("td",{className:"text-center font-bold text-lg",children:e.jsx(a,{value:r[r.length-1][1].playerResults[1].afterScore})}),e.jsx("td",{className:"text-center font-bold text-lg",children:e.jsx(a,{value:r[r.length-1][1].playerResults[2].afterScore})}),e.jsx("td",{className:"text-center font-bold text-lg",children:e.jsx(a,{value:r[r.length-1][1].playerResults[3].afterScore})})]})]})]})}function D({params:{matchId:s}}){const{rtMatch:l,rtMatchRounds:c,rtMatchCurrentRound:r}=C(s),[n,t]=b(!1),[h,f]=b(!1),[u,g]=j.useState(!1),[m,y]=j.useState(!1),v=j.useCallback(()=>{if(!l||!c)return;const N={_id:l.databaseId||s,...M(Object.values(c))};y(!0),fetch(`https://sakura2025.hkmahjong.org/api/match/${N._id}/result`,{method:"PATCH",body:JSON.stringify(N),headers:{Accept:"application/json"}}).then(()=>{g(!0),y(!1),alert(`上傳完畢。計算數據及更新官網需時幾分鐘，請等待一會後再到官網查看成績。

（強調：不需要去資料庫點擊更新成績的按鈕，這已經自動化了。）`)})},[l,s,c]);return!l||!r?e.jsx("div",{children:"對局讀取失敗。"}):e.jsx("div",{children:e.jsxs("div",{className:"container mx-auto my-8 px-8 space-y-6",children:[e.jsx("div",{children:e.jsx("h3",{className:"text-2xl text-center",children:l.name})}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm",children:["暫存資料庫ID: ",e.jsx("strong",{children:s})]}),e.jsxs("p",{className:"text-sm",children:["長久資料庫ID: ",e.jsx("strong",{children:l.databaseId})]})]}),e.jsx(w,{players:l.players,matchRounds:c,className:"w-full table-auto"}),e.jsxs("div",{className:"text-center max-w-[600px] mx-auto bg-amber-100 text-black p-4 space-y-6",children:[e.jsx("div",{children:e.jsxs("label",{className:"label",children:[e.jsx("input",{type:"checkbox",className:"checkbox",checked:n,onChange:t}),"已確認成績正確"]})}),e.jsx("div",{children:e.jsxs("label",{className:"label",children:[e.jsx("input",{type:"checkbox",className:"checkbox",checked:h,onChange:f}),"已播完賽後結果簡報"]})}),!u&&e.jsx("button",{className:"btn btn-primary btn-lg",disabled:m||!n||!h,onClick:v,children:m?"上傳中…":"上傳成績"}),u&&e.jsx("a",{href:`https://hkmjbs.sanity.studio/structure/general-list-matches-past;${s}`,children:e.jsx(S,{color:"secondary",children:"在資料庫上查看"})})]})]})})}export{D as default};
